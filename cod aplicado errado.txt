CREATE OR REPLACE FUNCTION public.buscar_perfis_por_habilidade(
    habilidade_texto text,
    cidade_texto text DEFAULT NULL,
    estado_texto text DEFAULT NULL,
    bairro_texto text DEFAULT NULL
)
RETURNS TABLE(
    id uuid,
    apelido text,
    titulo_profissional text,
    foto_perfil_url text,
    habilidades text[],
    avaliacao_media numeric,
    total_avaliacoes bigint
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    WITH avaliacoes_stats AS (
        SELECT
            os.trabalhador_id,
            COUNT(os.id) AS total_avaliacoes,
            AVG(
                (
                    (os.avaliacao_estrelas->>
